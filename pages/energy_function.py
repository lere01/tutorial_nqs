import io
import sys
import os
import json
import pandas as pd
import tempfile
import subprocess
import streamlit as st
import textwrap
from code_editor import code_editor

from vmc import VMC
from jax import lax, random
import jax.numpy as jnp
from typing import List
import matplotlib.pyplot as plt

x = [
    2.600721836090088,
    1.7623580694198608,
    1.1552048921585083,
    0.6817480325698853,
    0.3630564510822296,
    0.15891580283641815,
    0.015410499647259712,
    -0.08164896070957184,
    -0.13529716432094574,
    -0.17649248242378235,
    -0.20359671115875244,
    -0.2197190523147583,
    -0.24481166899204254,
    -0.2525745630264282,
    -0.2355884462594986,
    -0.2499677836894989,
    -0.2585175335407257,
    -0.25456735491752625,
    -0.25735408067703247,
    -0.2711423635482788,
    -0.2789372205734253,
    -0.27994513511657715,
    -0.2729725241661072,
    -0.2823996841907501,
    -0.29536059498786926,
    -0.2895395755767822,
    -0.2743038535118103,
    -0.2689533233642578,
    -0.2702464759349823,
    -0.24665085971355438,
    -0.23693135380744934,
    -0.2370639592409134,
    -0.25085628032684326,
    -0.21788229048252106,
    -0.2259902060031891,
    -0.18864481151103973,
    -0.22197188436985016,
    -0.2097817212343216,
    -0.18585066497325897,
    -0.20806223154067993,
    -0.20864850282669067,
    -0.21139052510261536,
    -0.2353234589099884,
    -0.23577286303043365,
    -0.24426427483558655,
    -0.2539560794830322,
    -0.23976130783557892,
    -0.25379595160484314,
    -0.24991729855537415,
    -0.2658095955848694,
    -0.2568472623825073,
    -0.2686748206615448,
    -0.27253708243370056,
    -0.28148093819618225,
    -0.26479822397232056,
    -0.27482497692108154,
    -0.2691672146320343,
    -0.2836538255214691,
    -0.26802510023117065,
    -0.2778916656970978,
    -0.2678290903568268,
    -0.2709443271160126,
    -0.2820202708244324,
    -0.2695145905017853,
    -0.2831273376941681,
    -0.24811963737010956,
    -0.2500978708267212,
    -0.2809571623802185,
    -0.25485503673553467,
    -0.2432105839252472,
    -0.270519882440567,
    -0.2630463242530823,
    -0.2710464894771576,
    -0.27850714325904846,
    -0.27223798632621765,
    -0.270108163356781,
    -0.2686524987220764,
    -0.25837230682373047,
    -0.2808719277381897,
    -0.2859407067298889,
    -0.2788791060447693,
    -0.269456684589386,
    -0.2893564701080322,
    -0.290183961391449,
    -0.280794620513916,
    -0.2882414162158966,
    -0.2942568063735962,
    -0.27528589963912964,
    -0.29102444648742676,
    -0.2748192250728607,
    -0.30061596632003784,
    -0.2975895404815674,
    -0.2765863835811615,
    -0.2942793667316437,
    -0.27792736887931824,
    -0.28522950410842896,
    -0.2885308861732483,
    -0.2998088598251343,
    -0.30468833446502686,
    -0.29508766531944275,
    -0.27697956562042236,
    -0.2865692675113678,
    -0.29162469506263733,
    -0.28416481614112854,
    -0.27340108156204224,
    -0.2866651117801666,
    -0.29534539580345154,
    -0.29618221521377563,
    -0.3001866638660431,
    -0.29215484857559204,
    -0.30020764470100403,
    -0.29559558629989624,
    -0.30938947200775146,
    -0.3095814287662506,
    -0.3144720196723938,
    -0.282598078250885,
    -0.3045676648616791,
    -0.31340548396110535,
    -0.29548126459121704,
    -0.30884039402008057,
    -0.3113195598125458,
    -0.30387988686561584,
    -0.30683478713035583,
    -0.30748364329338074,
    -0.30924469232559204,
    -0.31220418214797974,
    -0.3119450807571411,
    -0.31802472472190857,
    -0.3008921146392822,
    -0.3060019612312317,
    -0.30302223563194275,
    -0.3162405788898468,
    -0.32017916440963745,
    -0.317939430475235,
    -0.3220185339450836,
    -0.31746944785118103,
    -0.3145546615123749,
    -0.3308599591255188,
    -0.3138037919998169,
    -0.3276771903038025,
    -0.32510486245155334,
    -0.330171138048172,
    -0.32185259461402893,
    -0.31700599193573,
    -0.3143138587474823,
    -0.3229522109031677,
    -0.324811726808548,
    -0.3196265995502472,
    -0.3369382321834564,
    -0.323809415102005,
    -0.32575470209121704,
    -0.32460010051727295,
    -0.3196653127670288,
    -0.3301204442977905,
    -0.3299996256828308,
    -0.3207434117794037,
    -0.3273453414440155,
    -0.3283470571041107,
    -0.33271417021751404,
    -0.3254239559173584,
    -0.33913111686706543,
    -0.31969526410102844,
    -0.3365855813026428,
    -0.33624547719955444,
    -0.3386349678039551,
    -0.3230358958244324,
    -0.3355391025543213,
    -0.3365108370780945,
    -0.3339638113975525,
    -0.327517032623291,
    -0.3367117941379547,
    -0.34327858686447144,
    -0.3415481746196747,
    -0.34371820092201233,
    -0.3414922058582306,
    -0.3367287814617157,
    -0.33983373641967773,
    -0.3333904445171356,
    -0.3464031517505646,
    -0.33935803174972534,
    -0.34586021304130554,
    -0.34110498428344727,
    -0.35272958874702454,
    -0.3434548079967499,
    -0.3362041711807251,
    -0.3418693542480469,
    -0.3521230220794678,
    -0.35069790482521057,
    -0.35206758975982666,
    -0.34448909759521484,
    -0.3519141972064972,
    -0.3501524329185486,
    -0.3472743034362793,
    -0.3471037447452545,
    -0.3466881215572357,
    -0.34881216287612915,
    -0.3554879426956177,
    -0.3497719466686249,
    -0.3514012396335602,
    -0.34456801414489746,
    -0.3429153263568878,
    -0.3548283278942108,
    -0.3502333462238312,
    -0.3577926456928253,
    -0.35637736320495605,
    -0.36504945158958435,
    -0.34365302324295044,
    -0.3522281050682068,
    -0.3702009320259094,
    -0.3528061807155609,
    -0.35170674324035645,
    -0.362698495388031,
    -0.3513537645339966,
    -0.3616674840450287,
    -0.3552105128765106,
    -0.3657737076282501,
    -0.3654904365539551,
    -0.35899287462234497,
    -0.3663152754306793,
    -0.3521599769592285,
    -0.3549427092075348,
    -0.3513638973236084,
    -0.3548870384693146,
    -0.3617461621761322,
    -0.34790492057800293,
    -0.36117151379585266,
    -0.358580082654953,
    -0.35754042863845825,
    -0.3680552840232849,
    -0.3588796555995941,
    -0.3540492653846741,
    -0.35178616642951965,
    -0.35012510418891907,
    -0.3485180139541626,
    -0.3744291067123413,
    -0.3722694516181946,
    -0.3574303388595581,
    -0.3663782775402069,
    -0.3591909408569336,
    -0.37018221616744995,
    -0.3672652542591095,
    -0.35785549879074097,
    -0.36167600750923157,
    -0.3597310483455658,
    -0.35661524534225464,
    -0.34917354583740234,
    -0.35816892981529236,
    -0.3519902229309082,
    -0.35593581199645996,
    -0.3577839434146881,
    -0.3640036880970001,
    -0.36151444911956787,
    -0.37099379301071167,
    -0.3634403347969055,
    -0.37517020106315613,
    -0.35475000739097595,
    -0.36521315574645996,
    -0.3558468818664551,
    -0.3707677125930786,
    -0.3620027005672455,
    -0.36236628890037537,
    -0.356385201215744,
    -0.37770968675613403,
    -0.37269386649131775,
    -0.36341676115989685,
    -0.36485135555267334,
    -0.3565966784954071,
    -0.3601366877555847,
    -0.36166054010391235,
    -0.36798179149627686,
    -0.35444387793540955,
    -0.3655358850955963,
    -0.3653300404548645,
    -0.37023022770881653,
    -0.37331104278564453,
    -0.3728300929069519,
    -0.3635236322879791,
    -0.3665665090084076,
    -0.36650145053863525,
    -0.36639344692230225,
    -0.3547828197479248,
    -0.36908283829689026,
    -0.36432933807373047,
    -0.3775419592857361,
    -0.37249261140823364,
    -0.36103540658950806,
    -0.3626490831375122,
    -0.35780805349349976,
    -0.3662346303462982,
    -0.36984866857528687,
    -0.34899336099624634,
    -0.3640529215335846,
    -0.36727800965309143,
    -0.36906495690345764,
    -0.3609732389450073,
    -0.3652777373790741,
    -0.3676217794418335,
    -0.364519327878952,
    -0.36641737818717957,
    -0.3656395375728607,
    -0.3741093575954437,
    -0.37314310669898987,
    -0.36887356638908386,
    -0.367642343044281,
    -0.3666365444660187,
    -0.37163251638412476,
    -0.3561393916606903,
    -0.36235836148262024,
    -0.3573039472103119,
    -0.3703875243663788,
    -0.37307342886924744,
    -0.37218567728996277,
    -0.37076979875564575,
    -0.35746529698371887,
    -0.3673897981643677,
    -0.37480053305625916,
    -0.3609411120414734,
    -0.36434319615364075,
    -0.37757638096809387,
    -0.3651881217956543,
    -0.3677121102809906,
    -0.3724019229412079,
    -0.3712279796600342,
    -0.372335284948349,
    -0.363684743642807,
    -0.3726799190044403,
    -0.3815215826034546,
    -0.37475714087486267,
    -0.36502137780189514,
    -0.3749021589756012,
    -0.36890631914138794,
    -0.3765273690223694,
    -0.3709065318107605,
    -0.3797871768474579,
    -0.36674681305885315,
    -0.3676486313343048,
    -0.371367871761322,
    -0.3694974184036255,
    -0.378554105758667,
    -0.36712566018104553,
    -0.36253514885902405,
    -0.37488287687301636,
    -0.3659253418445587,
    -0.3776469826698303,
    -0.3730778396129608,
    -0.3673989474773407,
    -0.3733709752559662,
    -0.3684781491756439,
    -0.3675125241279602,
    -0.3692682087421417,
    -0.36444950103759766,
    -0.3764081299304962,
    -0.370572566986084,
    -0.36946821212768555,
    -0.37489083409309387,
    -0.3766176700592041,
    -0.3686719834804535,
    -0.3743658661842346,
    -0.3758043348789215,
    -0.36974939703941345,
    -0.37912601232528687,
    -0.3749600946903229,
    -0.3711948096752167,
    -0.38134056329727173,
    -0.37088465690612793,
    -0.37606343626976013,
    -0.36934128403663635,
    -0.37858515977859497,
    -0.3757583796977997,
    -0.37704983353614807,
    -0.3696609437465668,
    -0.37290412187576294,
    -0.3752152621746063,
    -0.37865763902664185,
    -0.3728887736797333,
    -0.3751339614391327,
    -0.37371233105659485,
    -0.37357521057128906,
    -0.38284093141555786,
    -0.38251790404319763,
    -0.3847191333770752,
    -0.37625908851623535,
    -0.3777852952480316,
    -0.3727067708969116,
    -0.3763749599456787,
    -0.37680116295814514,
    -0.36893367767333984,
    -0.37356704473495483,
    -0.38882437348365784,
    -0.36971232295036316,
    -0.373189777135849,
    -0.3707227110862732,
    -0.37713780999183655,
    -0.3806467354297638,
    -0.3696935176849365,
    -0.36995965242385864,
    -0.3781187832355499,
    -0.3855617046356201,
    -0.3663826882839203,
    -0.378913938999176,
    -0.36977618932724,
    -0.3644917607307434,
    -0.36908695101737976,
    -0.35807740688323975,
    -0.3738253712654114,
    -0.378974050283432,
    -0.3725610077381134,
    -0.3830392360687256,
    -0.38822272419929504,
    -0.3778272271156311,
    -0.37125805020332336,
    -0.37282270193099976,
    -0.374744713306427,
    -0.36912980675697327,
    -0.3764358162879944,
    -0.36651480197906494,
    -0.36898812651634216,
    -0.36993885040283203,
    -0.37236320972442627,
    -0.3742137551307678,
    -0.3807182312011719,
    -0.37413862347602844,
    -0.3824820816516876,
    -0.3752951920032501,
    -0.3776594400405884,
    -0.3743768632411957,
    -0.3863338828086853,
    -0.3808356523513794,
    -0.37844571471214294,
    -0.368441104888916,
    -0.36612188816070557,
    -0.380200058221817,
    -0.3697888255119324,
    -0.3737768828868866,
    -0.38008934259414673,
    -0.38100239634513855,
    -0.3806176781654358,
    -0.37885481119155884,
    -0.3744056820869446,
    -0.3810800313949585,
    -0.35850512981414795,
    -0.3723250925540924,
    -0.3770323097705841,
    -0.3757272958755493,
    -0.3820578455924988,
    -0.3743651211261749,
    -0.38194212317466736,
    -0.3817261755466461,
    -0.37698596715927124,
    -0.3801441192626953,
    -0.37607961893081665,
    -0.37881460785865784,
    -0.37046322226524353,
    -0.37827420234680176,
    -0.38562360405921936,
    -0.38134798407554626,
    -0.37929099798202515,
    -0.37547653913497925,
    -0.3875943720340729,
    -0.3754725158214569,
    -0.37846896052360535,
    -0.37897494435310364,
    -0.37702256441116333,
    -0.38711968064308167,
    -0.37430644035339355,
    -0.37444424629211426,
    -0.38395100831985474,
    -0.38048264384269714,
    -0.369401216506958,
    -0.3783843219280243,
    -0.37459540367126465,
    -0.37884992361068726,
    -0.3763447701931,
    -0.3776152729988098,
    -0.383045494556427,
    -0.37556663155555725,
    -0.37232568860054016,
    -0.3773980438709259,
    -0.37892839312553406,
    -0.3893406093120575,
    -0.3803879916667938,
    -0.3716075122356415,
    -0.3682175576686859,
    -0.3639368712902069,
    -0.3743782639503479,
    -0.3781187832355499,
    -0.3798997700214386,
    -0.3833479881286621,
    -0.3861488699913025,
    -0.3774619698524475,
    -0.3723044693470001,
    -0.37004145979881287,
    -0.3879651725292206,
    -0.35758212208747864,
    -0.3759610652923584,
    -0.37438055872917175,
    -0.3778826594352722,
    -0.38749179244041443,
    -0.38901668787002563,
    -0.3814527690410614,
    -0.384272038936615,
    -0.37937426567077637,
    -0.37709009647369385,
    -0.366061806678772,
    -0.3748546242713928,
    -0.37840840220451355,
    -0.38312187790870667,
    -0.37424084544181824,
    -0.37453699111938477,
    -0.3706957697868347,
    -0.3891400992870331,
    -0.3702312409877777,
    -0.38772672414779663,
    -0.3919641971588135,
    -0.378517210483551,
    -0.37730640172958374,
    -0.38068675994873047,
    -0.3718031048774719,
    -0.3656897246837616,
    -0.38244861364364624,
    -0.3775009512901306,
    -0.3790578842163086,
    -0.37842318415641785,
    -0.3846186697483063,
    -0.3806760311126709,
    -0.37625208497047424,
    -0.37499523162841797,
    -0.386466383934021,
    -0.37305954098701477,
    -0.3676539957523346,
    -0.36650124192237854,
    -0.37763771414756775,
    -0.3920939564704895,
    -0.37842342257499695,
    -0.37817853689193726,
    -0.3833869397640228,
    -0.3762884736061096,
    -0.3621366620063782,
    -0.37701284885406494,
    -0.3839404284954071,
    -0.38631585240364075,
    -0.3823976516723633,
    -0.39021632075309753,
    -0.39477649331092834,
    -0.3826081156730652,
    -0.37695589661598206,
    -0.3737717568874359,
    -0.3865501284599304,
    -0.3887719213962555,
    -0.37549975514411926,
    -0.37832191586494446,
    -0.38847002387046814,
    -0.39513030648231506,
    -0.3871629238128662,
    -0.3840908110141754,
    -0.38242873549461365,
    -0.3678474426269531,
    -0.3774603009223938,
    -0.385153591632843,
    -0.3816194534301758,
    -0.3766927719116211,
    -0.3897119462490082,
    -0.38599085807800293,
    -0.38050368428230286,
    -0.37414759397506714,
    -0.3740178048610687,
    -0.3691484034061432,
    -0.38042744994163513,
    -0.3752988874912262,
    -0.3730648458003998,
    -0.3716335892677307,
    -0.3831343650817871,
    -0.37880632281303406,
    -0.3899557888507843,
    -0.3859522342681885,
    -0.37932977080345154,
    -0.37636798620224,
    -0.38763105869293213,
    -0.37712207436561584,
    -0.38737916946411133,
    -0.3832438290119171,
    -0.3803878724575043,
    -0.38880637288093567,
    -0.38329169154167175,
    -0.3826594352722168,
    -0.3734753727912903,
    -0.3775253891944885,
    -0.3816111087799072,
    -0.38398420810699463,
    -0.38093698024749756,
    -0.3841492533683777,
    -0.37810295820236206,
    -0.37758344411849976,
    -0.389796644449234,
    -0.383730411529541,
    -0.37127020955085754,
    -0.3776978850364685,
    -0.3785778284072876,
    -0.37780556082725525,
    -0.3785311281681061,
    -0.3867211937904358,
    -0.38103097677230835,
    -0.38366395235061646,
    -0.383858859539032,
    -0.39135852456092834,
    -0.3861597180366516,
    -0.37578436732292175,
    -0.37750470638275146,
    -0.38163062930107117,
    -0.3827017843723297,
    -0.3791813552379608,
    -0.3811635375022888,
    -0.3830503821372986,
    -0.3932877480983734,
    -0.378108948469162,
    -0.3738882541656494,
    -0.36418476700782776,
    -0.39130282402038574,
    -0.3860556483268738,
    -0.3796970248222351,
    -0.3704667091369629,
    -0.38414454460144043,
    -0.38968923687934875,
    -0.3918326497077942,
    -0.37703487277030945,
    -0.3706842362880707,
    -0.3889351487159729,
    -0.38131630420684814,
    -0.3789978325366974,
    -0.38267287611961365,
    -0.3888717293739319,
    -0.39399105310440063,
    -0.3823804259300232,
    -0.38217055797576904,
    -0.376059353351593,
    -0.38576942682266235,
    -0.3812013268470764,
    -0.377993106842041,
    -0.3748306930065155,
    -0.38540273904800415,
    -0.3824233412742615,
    -0.38117924332618713,
    -0.3849492073059082,
    -0.3834607005119324,
    -0.38233524560928345,
    -0.3754282593727112,
    -0.3925066292285919,
    -0.36992356181144714,
    -0.38001886010169983,
    -0.37203142046928406,
    -0.38082966208457947,
    -0.39479702711105347,
    -0.3877376914024353,
    -0.37790557742118835,
    -0.3877149820327759,
    -0.39040064811706543,
    -0.37200385332107544,
    -0.3897631764411926,
    -0.38185322284698486,
    -0.3763870596885681,
    -0.3906385898590088,
    -0.3894956707954407,
    -0.39044448733329773,
    -0.37430867552757263,
    -0.386842280626297,
    -0.3809322118759155,
    -0.3748458921909332,
    -0.3911190927028656,
    -0.3755301535129547,
    -0.38230544328689575,
    -0.388534814119339,
    -0.3807324171066284,
    -0.3775424361228943,
    -0.3681391775608063,
    -0.38494154810905457,
    -0.3781561851501465,
    -0.38565096259117126,
    -0.38580164313316345,
    -0.3757961690425873,
    -0.37896066904067993,
    -0.3822467625141144,
    -0.3920118808746338,
    -0.40071210265159607,
    -0.3837428092956543,
    -0.37641286849975586,
    -0.36860474944114685,
    -0.38380441069602966,
    -0.38293465971946716,
    -0.3758225739002228,
    -0.38353416323661804,
    -0.3834060728549957,
    -0.39628779888153076,
    -0.3862437605857849,
    -0.3845732510089874,
    -0.38821157813072205,
    -0.3829469680786133,
    -0.37700900435447693,
    -0.38861361145973206,
    -0.38108113408088684,
    -0.3791406452655792,
    -0.3867674469947815,
    -0.3786011040210724,
    -0.3748380243778229,
    -0.3860897421836853,
    -0.380158931016922,
    -0.3818248510360718,
    -0.38553133606910706,
    -0.37622493505477905,
    -0.38152626156806946,
    -0.38658684492111206,
    -0.3834463059902191,
    -0.3858194053173065,
    -0.37859290838241577,
    -0.392686665058136,
    -0.3917224109172821,
    -0.36573609709739685,
    -0.37937065958976746,
    -0.37894636392593384,
    -0.3809536397457123,
    -0.39136385917663574,
    -0.3846966028213501,
    -0.37673401832580566,
    -0.37253034114837646,
    -0.3822838366031647,
    -0.3785583972930908,
    -0.38099852204322815,
    -0.39111319184303284,
    -0.38926950097084045,
    -0.37299564480781555,
    -0.3855196237564087,
    -0.3848752975463867,
    -0.3827072083950043,
    -0.3751894533634186,
    -0.3713301420211792,
    -0.36834949254989624,
    -0.3838751018047333,
    -0.3832131326198578,
    -0.3890312612056732,
    -0.4079316556453705,
    -0.3999423384666443,
    -0.3870663642883301,
    -0.38328781723976135,
    -0.379626601934433,
    -0.38560572266578674,
    -0.385253369808197,
    -0.3945799171924591,
    -0.3830410838127136,
    -0.3861910104751587,
    -0.3972527086734772,
    -0.39042767882347107,
    -0.36085596680641174,
    -0.36806929111480713,
    -0.3762681782245636,
    -0.388207346200943,
    -0.37996694445610046,
    -0.3885851502418518,
    -0.39469388127326965,
    -0.3923506438732147,
    -0.3927657902240753,
    -0.38334357738494873,
    -0.3764742612838745,
    -0.3715578317642212,
    -0.37846022844314575,
    -0.36877724528312683,
    -0.3835482597351074,
    -0.3863392174243927,
    -0.399225652217865,
    -0.38860198855400085,
    -0.38413313031196594,
    -0.38458484411239624,
    -0.3821500539779663,
    -0.37445011734962463,
    -0.37599876523017883,
    -0.38926559686660767,
    -0.3971071243286133,
    -0.40278592705726624,
    -0.381948322057724,
    -0.3859357237815857,
    -0.38416555523872375,
    -0.3758240044116974,
    -0.3817899823188782,
    -0.3819834589958191,
    -0.38865771889686584,
    -0.38612452149391174,
    -0.3910587430000305,
    -0.39475011825561523,
    -0.3914852440357208,
    -0.39463722705841064,
    -0.3758106231689453,
    -0.38946837186813354,
    -0.38305965065956116,
    -0.3939565122127533,
    -0.3838462829589844,
    -0.37579140067100525,
    -0.3888751268386841,
    -0.370007187128067,
    -0.3761375844478607,
    -0.3912088871002197,
    -0.388597697019577,
    -0.38887375593185425,
    -0.37738320231437683,
    -0.3841973543167114,
    -0.3750257194042206,
    -0.39081913232803345,
    -0.38325026631355286,
    -0.39466187357902527,
    -0.3943541944026947,
    -0.3866989314556122,
    -0.3879130482673645,
    -0.39300909638404846,
    -0.3875594139099121,
    -0.39289590716362,
    -0.38371771574020386,
    -0.3902049958705902,
    -0.38752561807632446,
    -0.3759820759296417,
    -0.390218585729599,
    -0.38732078671455383,
    -0.38038650155067444,
    -0.3916022479534149,
    -0.392475962638855,
    -0.3870331943035126,
    -0.4000588059425354,
    -0.38739895820617676,
    -0.39088672399520874,
    -0.37705665826797485,
    -0.3850264549255371,
    -0.3819481432437897,
    -0.3871104419231415,
    -0.3855220079421997,
    -0.3963720500469208,
    -0.38575875759124756,
    -0.3833036422729492,
    -0.38573819398880005,
    -0.3940240442752838,
    -0.3751958906650543,
    -0.38036298751831055,
    -0.39084309339523315,
    -0.3957762122154236,
    -0.3956855237483978,
    -0.3859187662601471,
    -0.3915785849094391,
    -0.38343849778175354,
    -0.3855551779270172,
    -0.39477047324180603,
    -0.3815282881259918,
    -0.3996244966983795,
    -0.3914242684841156,
    -0.39887842535972595,
    -0.3956732749938965,
    -0.3816942572593689,
    -0.37993180751800537,
    -0.3866421580314636,
    -0.3908731937408447,
    -0.3910799026489258,
    -0.39360731840133667,
    -0.39263588190078735,
    -0.39216506481170654,
    -0.39043787121772766,
    -0.39345434308052063,
    -0.38541173934936523,
    -0.38992273807525635,
    -0.386045902967453,
    -0.39080947637557983,
    -0.3928165137767792,
    -0.39249709248542786,
    -0.3863404393196106,
    -0.38217705488204956,
    -0.38465645909309387,
    -0.3891957402229309,
    -0.38408029079437256,
    -0.3949320614337921,
    -0.3884134888648987,
    -0.3881327211856842,
    -0.38705140352249146,
    -0.38253068923950195,
    -0.4024738669395447,
    -0.39403584599494934,
    -0.3889339864253998,
    -0.3910095989704132,
    -0.3866511881351471,
    -0.3931226134300232,
    -0.3949691951274872,
    -0.3938855528831482,
    -0.3915989398956299,
    -0.3985605239868164,
    -0.390519917011261,
    -0.38248658180236816,
    -0.3874496519565582,
    -0.3949016332626343,
    -0.39160341024398804,
    -0.37982869148254395,
    -0.3975296914577484,
    -0.3852497637271881,
    -0.3844129741191864,
    -0.39572790265083313,
    -0.38930007815361023,
    -0.39316487312316895,
    -0.3827584385871887,
    -0.4004068374633789,
    -0.38701891899108887,
    -0.3980947732925415,
    -0.38238704204559326,
    -0.39505359530448914,
    -0.39355817437171936,
    -0.40739795565605164,
    -0.3941563367843628,
    -0.38764655590057373,
    -0.3906000256538391,
    -0.4005720615386963,
    -0.38553544878959656,
    -0.38900965452194214,
    -0.39601919054985046,
    -0.3974795639514923,
    -0.3896009624004364,
    -0.3902600407600403,
    -0.3821803331375122,
    -0.398434579372406,
    -0.39350566267967224,
    -0.3934693932533264,
    -0.3878791630268097,
    -0.40556925535202026,
    -0.4059472382068634,
    -0.38650596141815186,
    -0.38511309027671814,
    -0.3873344361782074,
    -0.3914460837841034,
    -0.40048518776893616,
    -0.39994168281555176,
    -0.39392292499542236,
    -0.3918387293815613,
    -0.3879379332065582,
    -0.39462950825691223,
    -0.3861434757709503,
    -0.3948259949684143,
    -0.40145567059516907,
    -0.40069788694381714,
    -0.404143750667572,
    -0.40140098333358765,
    -0.3881804645061493,
    -0.39766260981559753,
    -0.3955977261066437,
    -0.39663025736808777,
    -0.3979458808898926,
    -0.3939680755138397,
    -0.39473769068717957,
    -0.398941308259964,
    -0.39563971757888794,
    -0.40025824308395386,
    -0.38926807045936584,
    -0.39203590154647827,
    -0.39102643728256226,
    -0.39614352583885193,
    -0.40065306425094604,
    -0.4026978313922882,
    -0.40799999237060547,
    -0.3939480185508728,
    -0.39199525117874146,
    -0.38312092423439026,
    -0.3836418688297272,
    -0.38730600476264954,
    -0.3888150155544281,
    -0.39468830823898315,
    -0.403084933757782,
    -0.39840927720069885,
    -0.3934703767299652,
    -0.3929981589317322,
    -0.3937935531139374,
    -0.37846583127975464,
    -0.40666618943214417,
    -0.4053603708744049,
    -0.4087566137313843,
    -0.3993646502494812,
    -0.40239980816841125,
    -0.3987679183483124,
    -0.39815279841423035,
    -0.3958239257335663,
    -0.393637478351593,
    -0.40964844822883606,
    -0.39375460147857666,
    -0.39750221371650696,
    -0.3982575535774231,
    -0.3918706774711609,
    -0.395519882440567,
    -0.40198060870170593,
    -0.39875441789627075,
    -0.41148728132247925,
    -0.4011106491088867,
    -0.4017638564109802,
    -0.39029330015182495,
    -0.3939095735549927,
    -0.39684951305389404,
    -0.4026503264904022,
    -0.40021562576293945,
    -0.40209195017814636,
    -0.39209306240081787,
    -0.3892310857772827,
    -0.39268758893013,
    -0.3983980417251587,
    -0.41152632236480713
]

st.set_page_config(
    page_title="Energy Function - NQS Tutorial",
    layout="wide",
    initial_sidebar_state="expanded",
)

# if "vmc_config" not in st.session_state:


cwd = os.getcwd()
button_file_path = os.path.join(cwd, "static", "buttons.json")
with open(button_file_path, "r") as file:
    buttons = json.load(file)

st.markdown(
    '<link href="../static/css/styles.css" rel="stylesheet">', unsafe_allow_html=True
)
st.title("Energy Function")



# Provide a code editor for the user to edit the code
st.markdown(
    """
    ### Compute the Local Energy
    Are you ready for some tasks? Replace all the `CHANGE_ME` in the code below with the appropriate code to compute the local energy. When you 
    are done, click the `Run Code` button or press `Ctrl + Enter` (`command + return` for Mac) to run the code.

    - :red[**WARNING**]: Only change the places where you find `CHANGE_ME`. Changing any other part of the code may result in an error.
    - :blue[**HINT**]: Remember that `delta` and `Omega` are the detuning and Rabi frequency respectively. They play crucial roles in the computation of the local energy.
    """
)

boilerplate_code = textwrap.dedent(
    """
    # Import Libraries
    import numpy as np

    # Define the Local Energy
    def local_energy():
        '''Compute the local energy of the wave function.'''
        print('Hello World!')

    local_energy()

    print('Completed!')
    """
)

runner_code_file = os.path.join(cwd, "src", "runner.py")
with open(runner_code_file, "r") as file:
    runner_code = file.read()
run_model_code = textwrap.dedent(runner_code)
run_model_globals = {
    "vmc_config": st.session_state.vmc_config,
    "model": st.session_state.model,
    "VMC": VMC,
    "jnp": jnp,
    "lax": lax,
    "List": List,
    "rng_key": random.PRNGKey(1234),
    "st": st,
    "io": io,
    "sys": sys,
    "delta": 1.0,
    "Omega": 1.0,
    "state": st.session_state,
}

# Display the code editor
completed_code = code_editor(
    run_model_code,
    lang="python",
    theme="contrast",
    height=300,
    buttons=buttons,
    key="run_model_code",
)

def energy_plot(densities):
    fig, ax = plt.subplots()

    ax.plot(densities, label='Energy Density', color='g')
    ax.set_ylabel('Energy Density')
    ax.set_xlabel('Training Epoch')
    ax.set_title('Energy Density Over Training Epoch')
    ax.hlines(-0.45776822, 0, 1000, colors='r', linestyles='dashed', label='Target Energy Density')
    ax.legend()

    st.pyplot(fig, use_container_width=False)


if completed_code["type"] == "submit":
    with st.spinner("Checking your solution..."):
        # initialize task statuses
        todo_1_correct = False
        todo_2_correct = False
        todo_3_correct = False

        # extract the code from the code editor
        code = completed_code["text"]
        code_lines = code.strip().split('\n')

        # Check if the user has completed the first todo
        todo_1 = code_lines[10].strip().split()

        if todo_1[3] != 'delta':
            st.write("You might want to check on ToDo_1")
        else:
            todo_1_correct = True
            st.write("Well done! You have successfully completed the todo 1.")

        # Check if the user has completed the second todo
        todo_2 = code_lines[25].strip().split()

        if todo_2[5] != 'Omega':
            st.write("You might want to check on ToDo_2")
        else:
            todo_2_correct = True
            st.write("Well done! You have successfully completed the todo 2.")

        # Check if the user has completed the third todo
        todo_3 = code_lines[39].strip().split()
        
        todo_terms = set(todo_3)
        # condition one: each of ['interaction_term', 'transverse_field', 'chemical_potential', 'loc_e'] must be present in the code
        condition_one = all(term in todo_terms for term in ['interaction_term', 'transverse_field', 'chemical_potential', 'loc_e'])

        # condition two: '=' must be the second item in todo_3, and '+' must be the fourth and sixth items
        condition_two = todo_3[1] == '=' and all(todo_3[i] == '+' for i in (3, 5))

        if not condition_one or not condition_two:
            st.write("You might want to check on ToDo_3")
        else:
            todo_3_correct = True
            st.write("Well done! You have successfully completed the todo 3.")

        # Display checkboxes
        st.subheader("Checklist")
        st.checkbox("TODO_1: step_fn_chemical correctly implemented", value=todo_1_correct, disabled=True)
        st.checkbox("TODO_2: step_fn_transverse correctly implemented", value=todo_2_correct, disabled=True)
        st.checkbox("TODO_3: Total energy computation correctly implemented", value=todo_3_correct, disabled=True)


    # Execute the code
    if all([todo_1_correct, todo_2_correct, todo_3_correct]):
        try:
            with st.spinner("Your model is training..."):
                exec(completed_code["text"], run_model_globals)

            energy_plot(st.session_state.densities)
        except Exception as e:
            st.error(f"Error executing code: {e}")


# Footer Navigation
col1, _, _, _, _, _, _, col2 = st.columns(8)

with col1:
    st.page_link(
        "pages/model_confirmation.py", label="Back", icon=":material/arrow_back:"
    )
